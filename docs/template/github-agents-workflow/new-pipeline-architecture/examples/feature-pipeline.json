{
  // FEATURE PIPELINE — Full lifecycle from backlog through design, implementation, review, and completion.
  // This is the most complex pipeline, handling multi-phase features, design reviews, and PR merge flows.
  // In TypeScript, this would be: const FEATURE_PIPELINE: PipelineDefinition = { ... } using STATUSES constants.

  "id": "feature",
  "label": "Feature Pipeline",
  "entryStatus": "Backlog",
  "terminalStatuses": ["Done"],

  "statuses": [
    { "id": "Backlog", "label": "Backlog" },

    // Design phases — each has an agent that produces design artifacts.
    // isDesignPhase: true enables design review actions (approve/changes/reject).
    { "id": "Product Development", "label": "Product Development", "agentPhase": "product-dev", "isDesignPhase": true },
    { "id": "Product Design", "label": "Product Design", "agentPhase": "product-design", "isDesignPhase": true },
    { "id": "Technical Design", "label": "Technical Design", "agentPhase": "tech-design", "isDesignPhase": true },

    // Implementation — "Ready for development" is the column name in GitHub Projects.
    // The implementation agent picks up items from this column.
    { "id": "Ready for development", "label": "Ready for Development", "agentPhase": "implementation" },

    // PR Review — the PR review agent examines the implementation PR.
    { "id": "PR Review", "label": "PR Review", "agentPhase": "pr-review" },

    // Final Review — only used for multi-phase features after the final PR is created.
    { "id": "Final Review", "label": "Final Review" },

    { "id": "Done", "label": "Done" }
  ],

  "transitions": [
    // ─── ENTRY ───────────────────────────────────────────────────────────

    {
      "id": "approve",
      "from": "Backlog",  // Items start in Backlog conceptually, approve creates the GitHub issue
      "to": "Backlog",
      "trigger": "system_approve",
      "guards": [
        { "id": "guard:not-double-approved" }
      ],
      "hooks": [
        // Before: create GitHub issue (must succeed for approval to proceed)
        { "id": "hook:create-github-issue", "phase": "before" },
        // After: sync status, log, notify
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-approved", "phase": "after", "optional": true }
      ],
      "description": "Approve a feature request — creates GitHub issue and syncs to workflow-items"
    },

    // ─── ROUTING (from Backlog to any phase) ─────────────────────────────

    {
      "id": "route-to-product-dev",
      "from": "Backlog",
      "to": "Product Development",
      "trigger": "admin_route",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:github-synced" },
        { "id": "guard:valid-routing-destination", "params": { "destination": "product-dev" } }
      ],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-routed", "phase": "after", "optional": true }
      ],
      "description": "Route feature to Product Development phase"
    },

    {
      "id": "route-to-product-design",
      "from": "Backlog",
      "to": "Product Design",
      "trigger": "admin_route",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:github-synced" },
        { "id": "guard:valid-routing-destination", "params": { "destination": "product-design" } }
      ],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-routed", "phase": "after", "optional": true }
      ],
      "description": "Route feature to Product Design phase"
    },

    {
      "id": "route-to-tech-design",
      "from": "Backlog",
      "to": "Technical Design",
      "trigger": "admin_route",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:github-synced" },
        { "id": "guard:valid-routing-destination", "params": { "destination": "tech-design" } }
      ],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-routed", "phase": "after", "optional": true }
      ],
      "description": "Route feature to Technical Design phase"
    },

    {
      "id": "route-to-implementation",
      "from": "Backlog",
      "to": "Ready for development",
      "trigger": "admin_route",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:github-synced" },
        { "id": "guard:valid-routing-destination", "params": { "destination": "implementation" } }
      ],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-routed", "phase": "after", "optional": true }
      ],
      "description": "Route feature directly to implementation (skip design)"
    },

    {
      "id": "route-to-backlog",
      "from": "*",  // Can route back to Backlog from any status
      "to": "Backlog",
      "trigger": "admin_route",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:github-synced" }
      ],
      "hooks": [
        // No clear-review for backlog routing
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:notify-routed", "phase": "after", "optional": true }
      ],
      "description": "Route feature back to Backlog from any status"
    },

    // ─── DESIGN PHASE FLOW ──────────────────────────────────────────────

    // Auto-advance after design review approval (used by reviewDesign 'approve' action)
    // STATUS_TRANSITIONS: Product Dev → Product Design → Tech Design → Ready for development
    {
      "id": "auto-advance-product-dev",
      "from": "Product Development",
      "to": "Product Design",
      "trigger": "auto_advance",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:notify-auto-advance", "phase": "after", "optional": true }
      ],
      "description": "Auto-advance from Product Development to Product Design after approval"
    },

    {
      "id": "auto-advance-product-design",
      "from": "Product Design",
      "to": "Technical Design",
      "trigger": "auto_advance",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:notify-auto-advance", "phase": "after", "optional": true }
      ],
      "description": "Auto-advance from Product Design to Technical Design after approval"
    },

    {
      "id": "auto-advance-tech-design",
      "from": "Technical Design",
      "to": "Ready for development",
      "trigger": "auto_advance",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:notify-auto-advance", "phase": "after", "optional": true }
      ],
      "description": "Auto-advance from Technical Design to Ready for Development after approval"
    },

    // Design approval via S3 (reads design from S3, saves artifact, advances)
    {
      "id": "approve-design-product-dev",
      "from": "Product Development",
      "to": "Product Design",
      "trigger": "admin_review_approve",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:read-design-from-s3", "phase": "before" },
        // save-design-artifact skipped for product-dev (no artifact to save)
        { "id": "hook:add-issue-comment", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Approve Product Development design, advance to Product Design"
    },

    {
      "id": "approve-design-product",
      "from": "Product Design",
      "to": "Technical Design",
      "trigger": "admin_review_approve",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:read-design-from-s3", "phase": "before" },
        { "id": "hook:save-design-artifact", "phase": "after" },
        { "id": "hook:add-issue-comment", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Approve Product Design, advance to Technical Design"
    },

    {
      "id": "approve-design-tech",
      "from": "Technical Design",
      "to": "Ready for development",
      "trigger": "admin_review_approve",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:read-design-from-s3", "phase": "before" },
        { "id": "hook:save-design-artifact", "phase": "after" },
        { "id": "hook:add-issue-comment", "phase": "after" },
        // Tech design approval initializes implementation phases
        { "id": "hook:initialize-phases", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Approve Technical Design, initialize phases, advance to Implementation"
    },

    {
      "id": "design-pr-request-changes",
      "from": "*",  // Can happen from any design phase
      "to": "*",    // Status unchanged — only review status changes
      "trigger": "admin_request_changes_design_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:in-design-phase" }
      ],
      "hooks": [
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Request changes on design PR — sets review status to Request Changes"
    },

    // ─── IMPLEMENTATION ──────────────────────────────────────────────────

    {
      "id": "agent-complete-implementation",
      "from": "Ready for development",
      "to": "PR Review",
      "trigger": "agent_complete",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Implementation agent created PR — advance to PR Review"
    },

    {
      "id": "pr-request-changes",
      "from": "PR Review",
      "to": "Ready for development",
      "trigger": "admin_request_changes_pr",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        // Status changes to Implementation but review status is set to Request Changes (not cleared)
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Request changes on implementation PR — return to Implementation with Request Changes"
    },

    // ─── MERGE TRANSITIONS ───────────────────────────────────────────────
    // Three variants sharing trigger: admin_merge_pr and from: PR Review.
    // The engine uses multi-match resolution: evaluates guards on each in order,
    // picks the first where all guards pass. Phase guards disambiguate.

    {
      "id": "merge-impl-pr",
      "from": "PR Review",
      "to": "Done",
      "trigger": "admin_merge_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:pr-exists" },
        { "id": "guard:commit-message-exists" },
        { "id": "guard:is-single-phase" }
      ],
      "hooks": [
        // Before: merge the PR (must succeed)
        { "id": "hook:merge-pr", "phase": "before" },
        // After: cleanup and completion
        { "id": "hook:save-phase-artifact", "phase": "after" },
        { "id": "hook:set-last-merged-pr", "phase": "after" },
        { "id": "hook:delete-pr-branch", "phase": "after", "optional": true },
        { "id": "hook:add-issue-comment", "phase": "after", "optional": true },
        // markDone hooks (inlined for single-phase)
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:clear-implementation-phase", "phase": "after" },
        { "id": "hook:update-source-doc-status", "phase": "after" },
        { "id": "hook:close-design-prs", "phase": "after", "optional": true },
        { "id": "hook:delete-s3-design-files", "phase": "after", "optional": true },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:sync-log-to-repo", "phase": "after", "optional": true }
      ],
      "description": "Merge single-phase implementation PR — marks Done"
    },

    {
      "id": "merge-impl-pr-next-phase",
      "from": "PR Review",
      "to": "Ready for development",
      "trigger": "admin_merge_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:pr-exists" },
        { "id": "guard:commit-message-exists" },
        { "id": "guard:is-middle-phase" }
      ],
      "hooks": [
        { "id": "hook:merge-pr", "phase": "before" },
        { "id": "hook:save-phase-artifact", "phase": "after" },
        { "id": "hook:set-last-merged-pr", "phase": "after" },
        { "id": "hook:delete-pr-branch", "phase": "after", "optional": true },
        { "id": "hook:add-issue-comment", "phase": "after", "optional": true },
        // Advance to next phase (e.g., "1/3" → "2/3")
        { "id": "hook:advance-implementation-phase", "phase": "after" },
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Merge multi-phase middle PR — advance phase, return to Implementation"
    },

    {
      "id": "merge-impl-pr-final",
      "from": "PR Review",
      "to": "Final Review",
      "trigger": "admin_merge_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:pr-exists" },
        { "id": "guard:commit-message-exists" },
        { "id": "guard:is-final-phase" }
      ],
      "hooks": [
        { "id": "hook:merge-pr", "phase": "before" },
        { "id": "hook:save-phase-artifact", "phase": "after" },
        { "id": "hook:set-last-merged-pr", "phase": "after" },
        { "id": "hook:delete-pr-branch", "phase": "after", "optional": true },
        { "id": "hook:add-issue-comment", "phase": "after", "optional": true },
        // Create final PR from feature branch to main
        { "id": "hook:create-final-pr", "phase": "after" },
        { "id": "hook:set-final-pr-number", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Merge multi-phase final PR — create final PR, advance to Final Review"
    },

    {
      "id": "merge-final-pr",
      "from": "Final Review",
      "to": "Done",
      "trigger": "admin_merge_final_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:pr-exists" }
      ],
      "hooks": [
        { "id": "hook:merge-final-pr", "phase": "before" },
        { "id": "hook:clean-up-task-branch", "phase": "after", "optional": true },
        { "id": "hook:add-issue-comment", "phase": "after", "optional": true },
        // markDone hooks
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:clear-implementation-phase", "phase": "after" },
        { "id": "hook:update-source-doc-status", "phase": "after" },
        { "id": "hook:close-design-prs", "phase": "after", "optional": true },
        { "id": "hook:delete-s3-design-files", "phase": "after", "optional": true },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:sync-log-to-repo", "phase": "after", "optional": true }
      ],
      "description": "Merge final PR — marks Done with full cleanup"
    },

    // ─── REVERT ──────────────────────────────────────────────────────────

    {
      "id": "revert-merge",
      "from": "*",  // Can revert from Done, PR Review, or any post-merge status
      "to": "Ready for development",
      "trigger": "admin_revert",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:merge-commit-sha-valid" }
      ],
      "hooks": [
        { "id": "hook:create-revert-pr", "phase": "before" },
        { "id": "hook:set-revert-pr-number", "phase": "after" },
        { "id": "hook:revert-source-doc-status", "phase": "after" },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Revert a merged PR — creates revert PR, returns to Implementation"
    },

    {
      "id": "merge-revert-pr",
      "from": "*",  // Current status may vary
      "to": "*",    // Status unchanged — just cleanup
      "trigger": "admin_merge_revert_pr",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:pr-open-and-not-merged" }
      ],
      "hooks": [
        { "id": "hook:merge-revert-pr", "phase": "before" },
        { "id": "hook:clear-revert-pr-number", "phase": "after" },
        { "id": "hook:delete-pr-branch", "phase": "after", "optional": true },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Merge the revert PR — cleanup only"
    },

    // ─── GLOBAL TRANSITIONS (from: '*') ──────────────────────────────────

    {
      "id": "manual-mark-done",
      "from": "*",
      "to": "Done",
      "trigger": "admin_mark_done",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:clear-review-status-db", "phase": "after" },
        { "id": "hook:clear-implementation-phase", "phase": "after" },
        { "id": "hook:update-source-doc-status", "phase": "after" },
        { "id": "hook:close-design-prs", "phase": "after", "optional": true },
        { "id": "hook:delete-s3-design-files", "phase": "after", "optional": true },
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" },
        { "id": "hook:sync-log-to-repo", "phase": "after", "optional": true }
      ],
      "description": "Admin manually marks item as Done from any status"
    },

    {
      "id": "manual-status-set",
      "from": "*",
      "to": "*",  // Target from context — used by UI updateStatus fallback
      "trigger": "admin_route",
      "guards": [{ "id": "guard:item-exists" }],
      "hooks": [
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Set arbitrary status via UI — fallback for items without routing destination mapping"
    },

    {
      "id": "undo-action",
      "from": "*",
      "to": "*",  // Target from context.restoreStatus
      "trigger": "admin_undo",
      "guards": [
        { "id": "guard:item-exists" },
        { "id": "guard:undo-window-valid" }
      ],
      "hooks": [
        { "id": "hook:sync-workflow-status", "phase": "after" },
        { "id": "hook:agent-log", "phase": "after" },
        { "id": "hook:history-log", "phase": "after" }
      ],
      "description": "Undo a status change within the 5-minute window"
    },

    {
      "id": "delete",
      "from": "*",
      "to": "*",  // Item removed from pipeline
      "trigger": "admin_delete",
      "guards": [
        { "id": "guard:not-github-synced" }  // Unless force: true in context
      ],
      "hooks": [
        { "id": "hook:delete-source-doc", "phase": "before" },
        { "id": "hook:delete-workflow-item", "phase": "after" },
        { "id": "hook:close-github-issue", "phase": "after", "optional": true },
        { "id": "hook:notify-deleted", "phase": "after", "optional": true }
      ],
      "description": "Delete workflow item — removes from all collections"
    }
  ],

  "reviewFlows": [
    {
      "statusId": "Product Development",
      "onAgentComplete": { "reviewStatus": "Waiting for Review" },
      "reviewActions": [
        { "action": "approve", "reviewStatus": "Approved", "triggersTransition": "auto-advance-product-dev" },
        { "action": "changes", "reviewStatus": "Request Changes" },
        { "action": "reject", "reviewStatus": "Rejected" }
      ]
    },
    {
      "statusId": "Product Design",
      "onAgentComplete": { "reviewStatus": "Waiting for Review" },
      "reviewActions": [
        { "action": "approve", "reviewStatus": "Approved", "triggersTransition": "auto-advance-product-design" },
        { "action": "changes", "reviewStatus": "Request Changes" },
        { "action": "reject", "reviewStatus": "Rejected" }
      ]
    },
    {
      "statusId": "Technical Design",
      "onAgentComplete": { "reviewStatus": "Waiting for Review" },
      "reviewActions": [
        { "action": "approve", "reviewStatus": "Approved", "triggersTransition": "auto-advance-tech-design" },
        { "action": "changes", "reviewStatus": "Request Changes" },
        { "action": "reject", "reviewStatus": "Rejected" }
      ]
    },
    {
      "statusId": "PR Review",
      "onAgentComplete": { "reviewStatus": "Waiting for Review" },
      "reviewActions": [
        { "action": "approve", "reviewStatus": "Approved" },
        { "action": "changes", "reviewStatus": "Request Changes", "triggersTransition": "pr-request-changes" }
      ]
    }
  ]
}
