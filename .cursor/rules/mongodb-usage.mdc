---
description: when accessing the databse or a collection in the db
globs: 
alwaysApply: false
---
# MongoDB Usage Guidelines

## Core Principles

1. **Encapsulation**: All MongoDB operations MUST be encapsulated within the `src/server/database` folder.
2. **No Direct MongoDB Imports**: Direct imports of `mongodb` libraries outside the database layer are STRICTLY PROHIBITED.
3. **Clean API Layer**: The API layer (`src/apis`) must ONLY interact with the database through functions exported from the database layer.
4. **Type Safety**: All database operations should use TypeScript interfaces for type safety.
5. **Use ID Utilities**: Always use `@/server/utils` for ID conversion - never direct ObjectId methods.

## Required Structure

Database operations must follow this structure:
```
/src
  /server
    /utils
      /id.ts                - ID conversion utilities (toStringId, toQueryId, toDocumentId)
      /index.ts             - Exports all utilities
    /database
      /index.ts             - Exports shared utilities and collection modules
      /collections
        /<collection-name>  - One folder per MongoDB collection
          /types.ts         - TypeScript interfaces for the collection
          /<collection-name>.ts - Database operations for the collection
```

## ID Handling (ObjectId vs UUID)

This app supports both MongoDB ObjectId (legacy) and UUID strings (client-generated) for `_id` fields.

### Required: Use Server Utilities

```typescript
import { toStringId, toQueryId, toDocumentId } from '@/server/utils';
```

| Utility | Use Case | Example |
|---------|----------|---------|
| `toStringId(id)` | API responses | `{ _id: toStringId(doc._id) }` |
| `toQueryId(id)` | MongoDB queries | `{ _id: toQueryId(clientId) }` |
| `toDocumentId(id)` | Document insertion | `{ _id: toDocumentId(clientId) }` |

### ❌ NEVER use direct ObjectId methods:

```typescript
// ❌ WRONG - Breaks on UUID strings
doc._id.toHexString()          // TypeError if UUID string
new ObjectId(clientId)          // BSONError if UUID string
{ _id: new ObjectId(id) }       // BSONError in queries

// ✅ CORRECT - Works for both formats
toStringId(doc._id)
toDocumentId(clientId)
{ _id: toQueryId(id) }
```

## Correct Usage Examples

### 1. Defining collection types:
```typescript
// src/server/database/collections/exercises/types.ts
import { ObjectId } from 'mongodb';

export interface Exercise {
  _id: ObjectId;  // Can be ObjectId or string in practice (for UUIDs)
  userId: ObjectId;
  // Other properties...
}

export type ExerciseCreate = Omit<Exercise, '_id'>;
export type ExerciseUpdate = Partial<Omit<Exercise, '_id' | 'userId'>>;
```

### 2. Implementing collection operations:
```typescript
// src/server/database/collections/exercises/exercises.ts
import { Collection, ObjectId } from 'mongodb';
import { getDb } from '@/server/database';
import { toQueryId } from '@/server/utils';
import { Exercise } from './types';

// Private function to get collection reference
const getExercisesCollection = async (): Promise<Collection<Exercise>> => {
  const db = await getDb();
  return db.collection<Exercise>('exercises');
};

// Public functions for database operations
export const findExerciseById = async (
  exerciseId: string, 
  userId: ObjectId | string
): Promise<Exercise | null> => {
  const collection = await getExercisesCollection();
  // Use toQueryId to handle both ObjectId and UUID formats
  return collection.findOne({ 
    _id: toQueryId(exerciseId) as any,
    userId: typeof userId === 'string' ? new ObjectId(userId) : userId
  });
};
```

### 3. Using in API layer:
```typescript
// src/apis/exercises/handlers/getExercise.ts
import { exercises } from '@/server/database';
import { toStringId } from '@/server/utils';
import { GetExerciseRequest, GetExerciseResponse } from '../types';

export const getExercise = async (
  params: GetExerciseRequest,
  context: { userId: string }
): Promise<GetExerciseResponse> => {
  try {
    const exercise = await exercises.findExerciseById(params.exerciseId, context.userId);
    if (!exercise) return { error: "Exercise not found" };
    
    // Use toStringId for response - works for both ObjectId and UUID
    return { 
      exercise: {
        ...exercise,
        _id: toStringId(exercise._id),
        userId: toStringId(exercise.userId),
      }
    };
  } catch (error) {
    return { error: "Failed to fetch exercise" };
  }
};
```

## What NOT To Do

### ❌ NEVER import MongoDB directly in API layer:
```typescript
// WRONG - This is forbidden
import { MongoClient, Collection } from 'mongodb';

const getExercises = async () => {
  const client = new MongoClient(process.env.MONGODB_URI!);
  const db = client.db('training_app');
  const collection = db.collection('exercises');
  
  return collection.find().toArray();
};
```

### ❌ NEVER access collections directly from API layer:
```typescript
// WRONG - This is forbidden
import { getDb } from '@/server/database';

const getExercises = async () => {
  const db = await getDb();
  const collection = db.collection('exercises');
  
  return collection.find().toArray();
};
```

### ❌ NEVER use direct ObjectId methods on IDs that could be UUIDs:
```typescript
// WRONG - Will crash on UUID strings from client-generated IDs
const response = {
  _id: doc._id.toHexString(),  // TypeError: toHexString is not a function
};

const item = await collection.findOne({
  _id: new ObjectId(clientId),  // BSONError: invalid ObjectId
});

// CORRECT - Use server utilities
import { toStringId, toQueryId } from '@/server/utils';

const response = {
  _id: toStringId(doc._id),  // Works for both ObjectId and string
};

const item = await collection.findOne({
  _id: toQueryId(clientId),  // Works for both formats
});
```

## Reference

- **Server Utilities**: `src/server/utils/id.ts`
- **Mutation Guidelines**: `docs/react-query-mutations.md` (client-generated IDs)
