---
description: when implementing a client-side feature that requires persistancy and can be configured by the user (settings/config/etc..)
globs: 
alwaysApply: false
---
# Settings Usage Guidelines

This document provides guidelines on how to use the application's settings feature using Zustand stores.

## Accessing Settings

Use the `useSettingsStore` hook from `src/client/stores/settingsStore.ts`:

```typescript
import { useSettingsStore } from '@/client/stores';

const MyComponent = () => {
    // Subscribe to specific settings slice (recommended)
    const aiModel = useSettingsStore((state) => state.settings.aiModel);
    const theme = useSettingsStore((state) => state.settings.theme);
    
    // Or get full settings object
    const settings = useSettingsStore((state) => state.settings);
    
    return <div>Current AI Model: {aiModel}</div>;
};
```

## Updating Settings

Use the `updateSettings` action from the store:

```typescript
import { useSettingsStore } from '@/client/stores';

const MyComponent = () => {
    const updateSettings = useSettingsStore((state) => state.updateSettings);

    const handleUpdateModel = (newModelId: string) => {
        updateSettings({ aiModel: newModelId });
    };

    const handleToggleOffline = () => {
        updateSettings({ offlineMode: true });
    };
};
```

## Offline Mode Detection

The app tracks both user-toggled offline mode and device connectivity:

```typescript
import { useSettingsStore, useEffectiveOffline } from '@/client/stores';

const MyComponent = () => {
    // User's manual offline mode setting
    const offlineMode = useSettingsStore((state) => state.settings.offlineMode);
    
    // Device online/offline status
    const isDeviceOffline = useSettingsStore((state) => state.isDeviceOffline);
    
    // Combined: true if EITHER user enabled offline mode OR device is offline
    const effectiveOffline = useEffectiveOffline();
    
    if (effectiveOffline) {
        return <OfflineBanner />;
    }
};
```

## Available Settings

Current settings fields (defined in `src/client/stores/types.ts`):

| Field | Type | Description |
|-------|------|-------------|
| `aiModel` | `string` | Selected AI model ID |
| `theme` | `'light' \| 'dark'` | UI theme |
| `offlineMode` | `boolean` | User-toggled offline mode |
| `staleWhileRevalidate` | `boolean` | Cache serving strategy |

## Adding a New Settings Field

1. **Update the `Settings` interface** in `src/client/stores/types.ts`:
   ```typescript
   export interface Settings {
       aiModel: string;
       theme: 'light' | 'dark';
       offlineMode: boolean;
       staleWhileRevalidate: boolean;
       newField: boolean; // Add your new field
   }
   ```

2. **Update `defaultSettings`** in `src/client/stores/settingsStore.ts`:
   ```typescript
   const defaultSettings: Settings = {
       aiModel: '',
       theme: 'light',
       offlineMode: false,
       staleWhileRevalidate: false,
       newField: false, // Provide default value
   };
   ```

3. **Settings automatically persist** to localStorage via Zustand's `persist` middleware.

4. **(Optional) Update the Settings UI** in `src/client/routes/Settings/Settings.tsx`.

## Clearing Cache

Use the API client directly (cache clearing is now separate from settings):

```typescript
import { clearCache } from '@/apis/settings/clearCache/client';
import { clientCacheProvider } from '@/client/utils/indexedDBCache';

const handleClearCache = async () => {
    // Clear server cache
    const result = await clearCache({});
    
    // Clear client IndexedDB cache
    await clientCacheProvider.clearAllCache();
};
```

## Key Files

- **Settings Types**: `src/client/stores/types.ts`
- **Settings Store**: `src/client/stores/settingsStore.ts`
- **Settings Page UI**: `src/client/routes/Settings/Settings.tsx`
- **All Stores Export**: `src/client/stores/index.ts`

## Migration Note

**Old pattern (deprecated):**
```typescript
// ❌ Don't use Context
import { useSettings } from '@/client/settings/SettingsContext';
const { settings, updateSettings } = useSettings();
```

**New pattern:**
```typescript
// ✅ Use Zustand store
import { useSettingsStore } from '@/client/stores';
const settings = useSettingsStore((state) => state.settings);
const updateSettings = useSettingsStore((state) => state.updateSettings);
```
