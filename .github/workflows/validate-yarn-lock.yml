name: Validate yarn.lock

on:
  pull_request:
    paths:
      - 'yarn.lock'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for yarn.lock changes
        run: |
          echo "üîç Checking if yarn.lock has been modified..."

          # Get the list of changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          if echo "$CHANGED_FILES" | grep -q "^yarn.lock$"; then
            echo ""
            echo "‚ùå ERROR: yarn.lock should not be modified in PRs"
            echo ""
            echo "This project uses a special yarn.lock setup:"
            echo "  - Local development: private npm registry (DO NOT COMMIT)"
            echo "  - Vercel/CI: public npm registry (committed version)"
            echo ""
            echo "To fix this PR:"
            echo "  git checkout origin/${{ github.base_ref }} -- yarn.lock"
            echo "  git commit -m 'chore: revert yarn.lock changes'"
            echo "  git push"
            echo ""
            exit 1
          fi

          echo "‚úÖ yarn.lock not modified - check passed"

      - name: Check for private registry URLs (if yarn.lock was somehow modified)
        if: failure()
        run: |
          echo "üîç Checking for private registry URLs..."

          # Check if yarn.lock contains non-public registry URLs
          # This catches cases where yarn.lock was modified despite the previous check
          if git show HEAD:yarn.lock | grep -v "registry.npmjs.org" | grep -E "https?://[^/]*registry" | grep -v "yarnpkg.com"; then
            echo ""
            echo "‚ùå ERROR: yarn.lock contains private registry URLs"
            echo ""
            echo "Found non-public registry URLs in yarn.lock."
            echo "This will break Vercel deployments."
            echo ""
            echo "Please revert yarn.lock to the version from main branch."
            echo ""
            exit 1
          fi

          echo "‚úÖ No private registry URLs found"
