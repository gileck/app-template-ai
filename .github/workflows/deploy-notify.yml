# Vercel Deployment Notifications via Telegram
#
# Sends Telegram notifications when Vercel deployments succeed or fail.
# Supports both Production (push to main) and Preview (pull requests).
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)
#
# Setup:
#   1. Run `yarn telegram-setup` to get your chat ID
#   2. Add secrets in GitHub: Settings ‚Üí Secrets and variables ‚Üí Actions

name: Deployment Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      deployments: read
      statuses: read
    env:
      IS_PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Set deployment type
        id: deploy-type
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            echo "env=Production" >> $GITHUB_OUTPUT
            echo "emoji=üöÄ" >> $GITHUB_OUTPUT
            echo "type=Production" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "env=Preview" >> $GITHUB_OUTPUT
            echo "emoji=üëÄ" >> $GITHUB_OUTPUT
            echo "type=Preview (PR #${{ github.event.pull_request.number }})" >> $GITHUB_OUTPUT
            # For PRs, Vercel uses the head commit SHA, not the merge commit
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Send deployment started notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            COMMIT_COUNT=$(echo "$COMMITS_JSON" | jq 'length')

            if [ "$COMMIT_COUNT" -eq 1 ]; then
              # Single commit - show commit name and Open Commit button
              COMMIT_MSG=$(echo "$HEAD_COMMIT_MESSAGE" | head -1)

              MESSAGE="üöÄ *Production Deployment Started*

          üì¶ Repository: ${{ github.repository }}
          üìù Commit: ${COMMIT_MSG}
          üë§ Author: ${{ github.actor }}"

              KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            else
              # Multiple commits - show count with 2 buttons
              MESSAGE="üöÄ *Production Deployment Started*

          üì¶ Repository: ${{ github.repository }}
          üìù Commits: ${COMMIT_COUNT} commits
          üë§ Author: ${{ github.actor }}"

              KEYBOARD='{"inline_keyboard":[[{"text":"üìä Open Diff","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}"},{"text":"üìã Show Commits","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}/commits"}]]}'
            fi

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            MESSAGE="üëÄ *Preview Deployment Started (PR #${{ github.event.pull_request.number }})*

          üì¶ Repository: ${{ github.repository }}
          üìù PR: ${{ github.event.pull_request.title }}
          üë§ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Wait for Vercel deployment
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: ${{ steps.deploy-type.outputs.env }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          echo "Waiting for Vercel $DEPLOY_ENV deployment (SHA: ${COMMIT_SHA::7})..."
          for i in {1..40}; do
            DEPLOY_URL=$(gh api repos/${{ github.repository }}/deployments \
              --jq ".[] | select(.sha==\"${COMMIT_SHA}\" and .environment==\"$DEPLOY_ENV\") | .id" \
              | head -1)

            if [ -n "$DEPLOY_URL" ]; then
              STATUS=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].state // "pending"')
              URL=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].environment_url // ""')
              DESCRIPTION=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].description // ""')
              echo "Deployment status: $STATUS"

              if [ "$STATUS" = "success" ]; then
                echo "url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment successful: $URL"
                exit 0
              elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
                echo "error=$DESCRIPTION" >> $GITHUB_OUTPUT
                echo "log_url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment failed: $DESCRIPTION"
                exit 1
              fi
            fi

            echo "Waiting... (attempt $i/40)"
            sleep 15
          done
          echo "error=Timeout waiting for deployment" >> $GITHUB_OUTPUT
          echo "Timeout waiting for deployment"
          exit 1

      - name: Send deployment success notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            COMMIT_COUNT=$(echo "$COMMITS_JSON" | jq 'length')

            if [ "$COMMIT_COUNT" -eq 1 ]; then
              # Single commit - show commit name and Open Commit button
              COMMIT_MSG=$(echo "$HEAD_COMMIT_MESSAGE" | head -1)

              MESSAGE="‚úÖ *Production Deployment Complete - Live*

          üì¶ Repository: ${{ github.repository }}
          üìù Commit: ${COMMIT_MSG}
          üë§ Author: ${{ github.actor }}"

              KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            else
              # Multiple commits - show count with 2 buttons
              MESSAGE="‚úÖ *Production Deployment Complete - Live*

          üì¶ Repository: ${{ github.repository }}
          üìù Commits: ${COMMIT_COUNT} commits
          üë§ Author: ${{ github.actor }}"

              KEYBOARD='{"inline_keyboard":[[{"text":"üìä Open Diff","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}"},{"text":"üìã Show Commits","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}/commits"}]]}'
            fi

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            MESSAGE="‚úÖ *Preview Deployment Ready (PR #${{ github.event.pull_request.number }})*

          üì¶ Repository: ${{ github.repository }}
          üìù PR: ${{ github.event.pull_request.title }}
          üë§ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"üîó Open URL","url":"${{ steps.deployment.outputs.url }}"},{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          ERROR_MSG: ${{ steps.deployment.outputs.error }}
          LOG_URL: ${{ steps.deployment.outputs.log_url }}
        run: |
          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          # Truncate error message if too long
          ERROR_PREVIEW="${ERROR_MSG:0:200}"
          if [ ${#ERROR_MSG} -gt 200 ]; then
            ERROR_PREVIEW="${ERROR_PREVIEW}..."
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            MESSAGE="‚ùå *Production Deployment Failed*

          üì¶ Repository: ${{ github.repository }}
          üë§ Author: ${{ github.actor }}"

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          üí• *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"üîç View Logs","url":"'"${LOG_URL}"'"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"üîç View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'
            fi
          else
            MESSAGE="‚ùå *Preview Deployment Failed (PR #${{ github.event.pull_request.number }})*

          üì¶ Repository: ${{ github.repository }}
          üìù PR: ${{ github.event.pull_request.title }}
          üë§ Author: ${{ github.actor }}"

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          üí• *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"üîç View Logs","url":"'"${LOG_URL}"'"},{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"üîç View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"},{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            fi
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            ${THREAD_PARAM} \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}" \
            -d "disable_web_page_preview=true"
