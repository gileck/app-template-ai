# Vercel Deployment Notifications via Telegram
#
# Sends Telegram notifications when Vercel deployments succeed or fail.
# Supports both Production (push to main) and Preview (pull requests).
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)
#
# Setup:
#   1. Run `yarn telegram-setup` to get your chat ID
#   2. Add secrets in GitHub: Settings â†’ Secrets and variables â†’ Actions

name: Deployment Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      deployments: read
      statuses: read
    env:
      IS_PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Set deployment type
        id: deploy-type
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            echo "env=Production" >> $GITHUB_OUTPUT
            echo "emoji=ğŸš€" >> $GITHUB_OUTPUT
            echo "type=Production" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "env=Preview" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ‘€" >> $GITHUB_OUTPUT
            echo "type=Preview (PR #${{ github.event.pull_request.number }})" >> $GITHUB_OUTPUT
            # For PRs, Vercel uses the head commit SHA, not the merge commit
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Send deployment started notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            # Get first line of commit message
            COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)

            MESSAGE="ğŸš€ *Production Deployment Started*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ Commit: ${COMMIT_MSG}
          ğŸ‘¤ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ“‹ Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            MESSAGE="ğŸ‘€ *Preview Deployment Started (PR #${{ github.event.pull_request.number }})*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ PR: ${{ github.event.pull_request.title }}
          ğŸ‘¤ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Wait for Vercel deployment
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: ${{ steps.deploy-type.outputs.env }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          echo "Waiting for Vercel $DEPLOY_ENV deployment (SHA: ${COMMIT_SHA::7})..."
          for i in {1..40}; do
            DEPLOY_URL=$(gh api repos/${{ github.repository }}/deployments \
              --jq ".[] | select(.sha==\"${COMMIT_SHA}\" and .environment==\"$DEPLOY_ENV\") | .id" \
              | head -1)

            if [ -n "$DEPLOY_URL" ]; then
              STATUS=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].state // "pending"')
              URL=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].environment_url // ""')
              DESCRIPTION=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].description // ""')
              echo "Deployment status: $STATUS"

              if [ "$STATUS" = "success" ]; then
                echo "url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment successful: $URL"
                exit 0
              elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
                echo "error=$DESCRIPTION" >> $GITHUB_OUTPUT
                echo "log_url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment failed: $DESCRIPTION"
                exit 1
              fi
            fi

            echo "Waiting... (attempt $i/40)"
            sleep 15
          done
          echo "error=Timeout waiting for deployment" >> $GITHUB_OUTPUT
          echo "Timeout waiting for deployment"
          exit 1

      - name: Send deployment success notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            # Get first line of commit message
            COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1)

            MESSAGE="âœ… *Production Deployment Complete - Live*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ Commit: ${COMMIT_MSG}
          ğŸ‘¤ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ“‹ Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            MESSAGE="âœ… *Preview Deployment Ready (PR #${{ github.event.pull_request.number }})*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ PR: ${{ github.event.pull_request.title }}
          ğŸ‘¤ Author: ${{ github.actor }}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ”— Open URL","url":"${{ steps.deployment.outputs.url }}"},{"text":"ğŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          ERROR_MSG: ${{ steps.deployment.outputs.error }}
          LOG_URL: ${{ steps.deployment.outputs.log_url }}
        run: |
          # Truncate error message if too long
          ERROR_PREVIEW="${ERROR_MSG:0:200}"
          if [ ${#ERROR_MSG} -gt 200 ]; then
            ERROR_PREVIEW="${ERROR_PREVIEW}..."
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            MESSAGE="âŒ *Production Deployment Failed*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ‘¤ Author: ${{ github.actor }}"

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          ğŸ’¥ *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ” View Logs","url":"'"${LOG_URL}"'"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ” View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'
            fi
          else
            MESSAGE="âŒ *Preview Deployment Failed (PR #${{ github.event.pull_request.number }})*

          ğŸ“¦ Repository: ${{ github.repository }}
          ğŸ“ PR: ${{ github.event.pull_request.title }}
          ğŸ‘¤ Author: ${{ github.actor }}"

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          ğŸ’¥ *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ” View Logs","url":"'"${LOG_URL}"'"},{"text":"ğŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"ğŸ” View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"},{"text":"ğŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            fi
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}" \
            -d "disable_web_page_preview=true"
