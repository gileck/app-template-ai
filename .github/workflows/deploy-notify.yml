# Vercel Deployment Notifications via Telegram
#
# Sends Telegram notifications when Vercel deployments succeed or fail.
# Supports both Production (push to main) and Preview (pull requests).
#
# Required GitHub Secrets:
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - OWNER_TELEGRAM_CHAT_ID: Chat ID to receive notifications
#
# Setup:
#   1. Run `yarn telegram-setup` to get your chat ID
#   2. Add secrets in GitHub: Settings ‚Üí Secrets and variables ‚Üí Actions

name: Deployment Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      IS_PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Set deployment type
        id: deploy-type
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            echo "env=Production" >> $GITHUB_OUTPUT
            echo "emoji=üöÄ" >> $GITHUB_OUTPUT
            echo "type=Production" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "env=Preview" >> $GITHUB_OUTPUT
            echo "emoji=üëÄ" >> $GITHUB_OUTPUT
            echo "type=Preview (PR #${{ github.event.pull_request.number }})" >> $GITHUB_OUTPUT
            # For PRs, Vercel uses the head commit SHA, not the merge commit
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Send deployment started notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.OWNER_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          MESSAGE="${{ steps.deploy-type.outputs.emoji }} *${{ steps.deploy-type.outputs.type }} Deployment Started*

          üì¶ Repository: ${{ github.repository }}
          üìù Commit: [${COMMIT_SHA::7}](${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA})
          üë§ Author: ${{ github.actor }}"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}"

      - name: Wait for Vercel deployment
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: ${{ steps.deploy-type.outputs.env }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          echo "Waiting for Vercel $DEPLOY_ENV deployment (SHA: ${COMMIT_SHA::7})..."
          for i in {1..40}; do
            DEPLOY_URL=$(gh api repos/${{ github.repository }}/deployments \
              --jq ".[] | select(.sha==\"${COMMIT_SHA}\" and .environment==\"$DEPLOY_ENV\") | .id" \
              | head -1)

            if [ -n "$DEPLOY_URL" ]; then
              STATUS=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].state // "pending"')
              URL=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].environment_url // ""')
              echo "Deployment status: $STATUS"

              if [ "$STATUS" = "success" ]; then
                echo "url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment successful: $URL"
                exit 0
              elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
                echo "Deployment failed"
                exit 1
              fi
            fi

            echo "Waiting... (attempt $i/40)"
            sleep 15
          done
          echo "Timeout waiting for deployment"
          exit 1

      - name: Send deployment success notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.OWNER_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            TITLE="‚úÖ *Production Deployment Complete - Live*"
          else
            TITLE="‚úÖ *Preview Deployment Ready (PR #${{ github.event.pull_request.number }})*"
          fi

          MESSAGE="${TITLE}

          üì¶ Repository: ${{ github.repository }}
          üìù Commit: [${COMMIT_SHA::7}](${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA})
          üë§ Author: ${{ github.actor }}"

          KEYBOARD='{"inline_keyboard":[[{"text":"üîó Open URL","url":"${{ steps.deployment.outputs.url }}"}]]}'

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}"

      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.OWNER_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          MESSAGE="‚ùå *${{ steps.deploy-type.outputs.type }} Deployment Failed*

          üì¶ Repository: ${{ github.repository }}
          üìù Commit: [${COMMIT_SHA::7}](${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA})
          üë§ Author: ${{ github.actor }}
          üîç [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}"
