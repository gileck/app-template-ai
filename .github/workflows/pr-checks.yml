# PR Code Quality Checks
#
# Runs all code quality checks in parallel on pull requests.
# Each check runs as a separate job for better visibility and faster execution.
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  # TypeScript type checking
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run TypeScript check
        run: yarn ts

  # ESLint code quality
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run ESLint check
        run: yarn lint

  # Circular dependency detection
  circular:
    name: Circular Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run circular dependency check
        run: yarn check:circular

  # Unused dependencies detection
  unused:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run unused dependencies check
        run: yarn check:unused:ci --no-config-hints

  # Summary job - runs after all checks complete
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [typescript, lint, circular, unused]
    if: always()
    steps:
      - name: Check results
        id: results
        run: |
          # Collect results from all jobs
          TS_RESULT="${{ needs.typescript.result }}"
          LINT_RESULT="${{ needs.lint.result }}"
          CIRCULAR_RESULT="${{ needs.circular.result }}"
          UNUSED_RESULT="${{ needs.unused.result }}"

          # Build failure message
          FAILURES=""
          if [ "$TS_RESULT" != "success" ]; then FAILURES="$FAILURES TypeScript"; fi
          if [ "$LINT_RESULT" != "success" ]; then FAILURES="$FAILURES ESLint"; fi
          if [ "$CIRCULAR_RESULT" != "success" ]; then FAILURES="$FAILURES Circular"; fi
          if [ "$UNUSED_RESULT" != "success" ]; then FAILURES="$FAILURES Unused"; fi

          # Set outputs
          if [ -z "$FAILURES" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "failures=" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (failure)
        if: steps.results.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const failures = '${{ steps.results.outputs.failures }}'.trim().split(' ').filter(Boolean);
            const failureList = failures.map(f => `- ${f}`).join('\n');

            const body = `## :x: Code Quality Checks Failed

            **Failed checks:**
            ${failureList}

            | Check | Status |
            |-------|--------|
            | TypeScript | ${{ needs.typescript.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | ESLint | ${{ needs.lint.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | Circular Dependencies | ${{ needs.circular.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | Unused Dependencies | ${{ needs.unused.result == 'success' && ':white_check_mark:' || ':x:' }} |

            > Click on the failed job above to see details.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR (success)
        if: steps.results.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :white_check_mark: Code Quality Checks Passed\n\nAll checks completed successfully.'
            });

      - name: Send Telegram notification (failure)
        if: steps.results.outputs.status == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
        run: |
          FAILURES="${{ steps.results.outputs.failures }}"

          MESSAGE="‚ö†Ô∏è *Code Checks Failed (PR #${{ github.event.pull_request.number }})*

          üìù PR: ${{ github.event.pull_request.title }}
          ‚ùå Failed: ${FAILURES}
          üë§ Author: ${{ github.actor }}"

          KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"},{"text":"üîç View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}"
