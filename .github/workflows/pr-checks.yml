# PR Code Quality Checks
#
# Runs yarn checks:ci on pull requests. Does not block merge but reports failures
# via GitHub PR comment and Telegram notification.
#
# Note: Uses checks:ci which runs BOTH TypeScript and ESLint, showing ALL errors
# at once instead of failing fast on the first error.
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - name: Install dependencies
        run: yarn install

      - name: Run checks
        id: checks
        run: |
          set +e
          OUTPUT=$(yarn checks:ci 2>&1)
          EXIT_CODE=$?

          # Save output to file for multiline handling
          echo "$OUTPUT" > checks_output.txt

          # Extract error count if present
          ERROR_COUNT=$(echo "$OUTPUT" | grep -oE '[0-9]+ error' | head -1 | grep -oE '[0-9]+' || echo "0")
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT

          echo "$OUTPUT"
          exit $EXIT_CODE

      - name: Comment on PR (failure)
        if: failure() && steps.checks.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = 'No output captured';
            try {
              output = fs.readFileSync('checks_output.txt', 'utf8');
            } catch (e) {
              // File doesn't exist
            }

            // Truncate if too long
            const maxLength = 60000;
            const truncatedOutput = output.length > maxLength
              ? output.substring(0, maxLength) + '\n\n... (truncated)'
              : output;

            const body = `## ‚ùå Code Quality Checks Failed

            **PR:** #${{ github.event.pull_request.number }}
            **Errors:** ${{ steps.checks.outputs.error_count }}

            <details>
            <summary>Click to see full output</summary>

            \`\`\`
            ${truncatedOutput}
            \`\`\`

            </details>

            > This check is non-blocking. You can still merge, but please consider fixing these issues.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR (success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ‚úÖ Code Quality Checks Passed\n\nAll checks completed successfully.'
            });

      - name: Send Telegram notification (failure)
        if: failure() && steps.checks.outcome == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
        run: |
          MESSAGE="‚ö†Ô∏è *Code Checks Failed (PR #${{ github.event.pull_request.number }})*

          üìù PR: ${{ github.event.pull_request.title }}
          üî¢ Errors: ${{ steps.checks.outputs.error_count }}
          üë§ Author: ${{ github.actor }}"

          KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"},{"text":"üîç View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}"
