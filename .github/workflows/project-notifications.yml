name: Project Status Notifications

# Trigger on Projects V2 item changes
on:
  projects_v2_item:
    types: [created, edited, deleted]

jobs:
  notify-status-change:
    runs-on: ubuntu-latest
    # Only run if TELEGRAM_NOTIFICATIONS_ENABLED is set
    if: ${{ vars.TELEGRAM_NOTIFICATIONS_ENABLED == 'true' }}

    steps:
      - name: Get Project Item Details
        id: get-details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const itemId = context.payload.projects_v2_item.node_id;
            const projectNumber = context.payload.projects_v2_item.project_node_id;

            // Query for item details including the linked issue/PR
            const query = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    id
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2SingleSelectField {
                              name
                            }
                          }
                        }
                      }
                    }
                    content {
                      ... on Issue {
                        number
                        title
                        url
                      }
                      ... on PullRequest {
                        number
                        title
                        url
                      }
                    }
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(query, { itemId });

              if (!result.node || !result.node.content) {
                console.log('No content found for item');
                return;
              }

              const content = result.node.content;
              const fieldValues = result.node.fieldValues?.nodes || [];

              // Find Status field value
              let status = 'Unknown';
              for (const fv of fieldValues) {
                if (fv?.field?.name === 'Status' && fv.name) {
                  status = fv.name;
                  break;
                }
              }

              core.setOutput('number', content.number);
              core.setOutput('title', content.title);
              core.setOutput('url', content.url);
              core.setOutput('status', status);
              core.setOutput('found', 'true');
            } catch (error) {
              console.log('Error fetching item details:', error.message);
              core.setOutput('found', 'false');
            }

      - name: Send Telegram Notification
        if: steps.get-details.outputs.found == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          ITEM_NUMBER: ${{ steps.get-details.outputs.number }}
          ITEM_TITLE: ${{ steps.get-details.outputs.title }}
          ITEM_URL: ${{ steps.get-details.outputs.url }}
          ITEM_STATUS: ${{ steps.get-details.outputs.status }}
          EVENT_ACTION: ${{ github.event.action }}
          ACTOR: ${{ github.actor }}
        run: |
          MESSAGE=""

          case "$EVENT_ACTION" in
            created)
              MESSAGE="üìã *Added to Project*%0A%0A#${ITEM_NUMBER}: ${ITEM_TITLE}%0A%0Aüìä Status: ${ITEM_STATUS}%0Aüë§ by ${ACTOR}%0Aüîó ${ITEM_URL}"
              ;;
            edited)
              MESSAGE="üìä *Status Changed*%0A%0A#${ITEM_NUMBER}: ${ITEM_TITLE}%0A%0A‚û°Ô∏è ${ITEM_STATUS}%0Aüë§ by ${ACTOR}%0Aüîó ${ITEM_URL}"
              ;;
            deleted)
              MESSAGE="üóëÔ∏è *Removed from Project*%0A%0A#${ITEM_NUMBER}: ${ITEM_TITLE}%0A%0Aüë§ by ${ACTOR}"
              ;;
          esac

          if [ -n "$MESSAGE" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
          fi
