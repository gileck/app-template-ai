name: Reset Review Status on Status Change

# Automatically reset Review Status when the main Status field changes
# This prevents confusion when moving items between phases

on:
  projects_v2_item:
    types: [edited]

env:
  REVIEW_STATUS_FIELD: 'Review Status'
  # Review phases that should have Review Status set
  REVIEW_PHASES: 'Product Design Review,Technical Design Review,PR Review'

jobs:
  reset-review-status:
    runs-on: ubuntu-latest
    # Only run if AUTO_RESET_REVIEW_STATUS is enabled (default: true)
    if: ${{ vars.AUTO_RESET_REVIEW_STATUS != 'false' }}

    steps:
      - name: Check and Reset Review Status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const itemId = context.payload.projects_v2_item.node_id;
            const projectNodeId = context.payload.projects_v2_item.project_node_id;
            const reviewStatusFieldName = process.env.REVIEW_STATUS_FIELD;
            const reviewPhases = process.env.REVIEW_PHASES.split(',').map(s => s.trim());

            console.log('Processing item:', itemId);

            // Query to get item details and project fields
            const itemQuery = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    id
                    fieldValues(first: 20) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          optionId
                          field {
                            ... on ProjectV2SingleSelectField {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            // Query to get project fields and options
            const projectFieldsQuery = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: 30) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              // Get current item field values
              const itemResult = await github.graphql(itemQuery, { itemId });
              if (!itemResult.node) {
                console.log('Item not found');
                return;
              }

              const fieldValues = itemResult.node.fieldValues?.nodes || [];

              // Find current Status value
              let currentStatus = null;
              let currentReviewStatus = null;
              let reviewStatusFieldId = null;

              for (const fv of fieldValues) {
                if (fv?.field?.name === 'Status') {
                  currentStatus = fv.name;
                }
                if (fv?.field?.name === reviewStatusFieldName) {
                  currentReviewStatus = fv.name;
                  reviewStatusFieldId = fv.field.id;
                }
              }

              console.log('Current Status:', currentStatus);
              console.log('Current Review Status:', currentReviewStatus);

              // If we don't have a Review Status field ID, get it from project fields
              if (!reviewStatusFieldId) {
                const fieldsResult = await github.graphql(projectFieldsQuery, { projectId: projectNodeId });
                const fields = fieldsResult.node?.fields?.nodes || [];

                for (const field of fields) {
                  if (field.name === reviewStatusFieldName) {
                    reviewStatusFieldId = field.id;
                    break;
                  }
                }
              }

              if (!reviewStatusFieldId) {
                console.log('Review Status field not found in project');
                return;
              }

              // Get project field options for Review Status
              const fieldsResult = await github.graphql(projectFieldsQuery, { projectId: projectNodeId });
              const fields = fieldsResult.node?.fields?.nodes || [];

              let reviewStatusOptions = new Map();
              for (const field of fields) {
                if (field.name === reviewStatusFieldName && field.options) {
                  for (const opt of field.options) {
                    reviewStatusOptions.set(opt.name, opt.id);
                  }
                  break;
                }
              }

              // Determine if we need to reset Review Status
              const isReviewPhase = reviewPhases.includes(currentStatus);

              // If NOT in a review phase, clear the Review Status
              // If IN a review phase and Review Status is "Approved", reset to "Waiting for Review"
              let shouldUpdate = false;
              let newReviewStatusOptionId = null;

              if (!isReviewPhase && currentReviewStatus) {
                // Clear Review Status when not in a review phase
                console.log('Not in review phase, clearing Review Status');
                shouldUpdate = true;
                newReviewStatusOptionId = null; // Clear the field
              } else if (isReviewPhase && currentReviewStatus === 'Approved') {
                // Reset to Waiting for Review if currently Approved and in a review phase
                const waitingId = reviewStatusOptions.get('Waiting for Review');
                if (waitingId) {
                  console.log('In review phase with Approved status, resetting to Waiting for Review');
                  shouldUpdate = true;
                  newReviewStatusOptionId = waitingId;
                }
              }

              if (!shouldUpdate) {
                console.log('No update needed');
                return;
              }

              // Update the Review Status field
              if (newReviewStatusOptionId) {
                // Set to a specific value
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }
                    ) {
                      projectV2Item { id }
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectNodeId,
                  itemId: itemId,
                  fieldId: reviewStatusFieldId,
                  optionId: newReviewStatusOptionId
                });

                console.log('Review Status updated to: Waiting for Review');
              } else {
                // Clear the field
                const clearMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!) {
                    clearProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                      }
                    ) {
                      projectV2Item { id }
                    }
                  }
                `;

                await github.graphql(clearMutation, {
                  projectId: projectNodeId,
                  itemId: itemId,
                  fieldId: reviewStatusFieldId
                });

                console.log('Review Status cleared');
              }

            } catch (error) {
              console.error('Error:', error.message);
              // Don't fail the workflow for errors
            }
