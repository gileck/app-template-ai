name: Mark Issue Done on PR Merge

# Trigger when a PR is closed
on:
  pull_request:
    types: [closed]

jobs:
  mark-done:
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Mark issue as Done
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          GITHUB_OWNER: ${{ vars.PROJECT_OWNER }}
          GITHUB_REPO: ${{ vars.PROJECT_REPO }}
          GITHUB_PROJECT_NUMBER: ${{ vars.PROJECT_NUMBER }}
          GITHUB_OWNER_TYPE: ${{ vars.PROJECT_OWNER_TYPE }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          yarn tsx scripts/mark-issue-done.ts
